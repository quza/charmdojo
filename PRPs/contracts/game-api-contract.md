# Game API Contract

**Version:** 1.0  
**Last Updated:** October 23, 2025  
**Base URL:** `/api/game`

---

## Overview

Game management endpoints for girl generation, round initialization, and round completion.

---

## Endpoints

### 1. Generate Girl Profiles

**Endpoint:** `POST /api/game/generate-girls`  
**Purpose:** Generate 3 AI girl profiles for user selection  
**Authentication:** Required (Bearer token)

#### Request

```typescript
interface GenerateGirlsRequest {
  // No body required - generates random profiles
}
```

#### Response (200 OK)

```typescript
interface GenerateGirlsResponse {
  girls: Girl[];
  generationTime: number;  // Milliseconds
}

interface Girl {
  id: string;              // Temporary UUID for selection
  name: string;            // Random from girl_names.txt
  imageUrl: string;        // Public URL to generated image
  attributes: {
    ethnicity: string;
    hairColor: string;
    eyeColor: string;
    bodyType: string;
    hairstyle: string;
    setting: string;
  };
}
```

**Example Response:**
```json
{
  "girls": [
    {
      "id": "temp_550e8400-e29b-41d4-a716-446655440000",
      "name": "Emma",
      "imageUrl": "https://storage.supabase.co/charmdojo/girls/img_abc123.jpg",
      "attributes": {
        "ethnicity": "Caucasian",
        "hairColor": "Blonde",
        "eyeColor": "Blue",
        "bodyType": "Athletic",
        "hairstyle": "Long wavy",
        "setting": "Coffee shop"
      }
    },
    // ... 2 more girls
  ],
  "generationTime": 8234
}
```

#### Error Responses

**401 Unauthorized**
```json
{
  "error": "unauthorized",
  "message": "Authentication required",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**402 Payment Required - Free Tier Limit**
```json
{
  "error": "free_tier_limit_reached",
  "message": "You've reached your daily limit of 5 rounds. Upgrade to Premium for unlimited rounds.",
  "limit": 5,
  "used": 5,
  "resetAt": "2025-10-24T00:00:00Z",
  "upgradeUrl": "/pricing",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**429 Too Many Requests**
```json
{
  "error": "rate_limit_exceeded",
  "message": "Please wait before generating new profiles",
  "retry_after": 30,
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**503 Service Unavailable - Image Generation Failed**
```json
{
  "error": "image_generation_failed",
  "message": "Image generation service is temporarily unavailable. Please try again.",
  "fallback": "using_cached_profiles",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

---

### 2. Start Game Round

**Endpoint:** `POST /api/game/start-round`  
**Purpose:** Initialize conversation with selected girl  
**Authentication:** Required (Bearer token)

#### Request

```typescript
interface StartRoundRequest {
  girlId: string;          // Temporary UUID from generate-girls response
  girlData: Girl;          // Complete girl object for persistence
}
```

**Validation Rules:**
- `girlId`: Required, must be valid UUID
- `girlData`: Required, must match Girl interface

#### Response (201 Created)

```typescript
interface StartRoundResponse {
  roundId: string;                 // UUID - primary key for this round
  girl: {
    name: string;
    imageUrl: string;
    description: string;           // Generated by Vision AI
    persona: string;               // e.g., "playful", "confident", "witty"
    attributes: Girl['attributes'];
  };
  successMeter: number;            // Initial value: 20
  conversationHistory: Message[];  // Empty array initially
  createdAt: string;               // ISO 8601
}

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: string;  // ISO 8601
}
```

**Example Response:**
```json
{
  "roundId": "round_7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "girl": {
    "name": "Emma",
    "imageUrl": "https://storage.supabase.co/...",
    "description": "A stunning woman in her mid-twenties with flowing blonde hair and piercing blue eyes. She has an athletic build and exudes confidence. She's wearing casual attire in a modern coffee shop setting, with a warm, inviting smile.",
    "persona": "playful",
    "attributes": {
      "ethnicity": "Caucasian",
      "hairColor": "Blonde",
      "eyeColor": "Blue",
      "bodyType": "Athletic",
      "hairstyle": "Long wavy",
      "setting": "Coffee shop"
    }
  },
  "successMeter": 20,
  "conversationHistory": [],
  "createdAt": "2025-10-23T10:30:00Z"
}
```

#### Error Responses

**400 Bad Request - Invalid Girl Data**
```json
{
  "error": "invalid_girl_data",
  "message": "Girl data is invalid or incomplete",
  "details": [
    {
      "field": "girlId",
      "message": "Invalid UUID format"
    }
  ],
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**402 Payment Required**
```json
{
  "error": "free_tier_limit_reached",
  "message": "You've reached your daily limit of 5 rounds.",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**500 Internal Server Error - Description Generation Failed**
```json
{
  "error": "description_generation_failed",
  "message": "Failed to generate girl description",
  "fallback": "using_template_description",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

---

### 3. Get Round Details

**Endpoint:** `GET /api/game/rounds/{roundId}`  
**Purpose:** Retrieve current state of a game round  
**Authentication:** Required (Bearer token)

#### Request

**Path Parameters:**
- `roundId` (string, UUID): The round identifier

**Query Parameters:**
- None

#### Response (200 OK)

```typescript
interface RoundDetailsResponse {
  round: {
    id: string;
    userId: string;
    girlName: string;
    girlImageUrl: string;
    girlDescription: string;
    girlPersona: string;
    initialMeter: number;
    currentMeter: number;
    finalMeter: number | null;
    result: 'win' | 'lose' | 'abandoned' | null;
    messageCount: number;
    startedAt: string;    // ISO 8601
    completedAt: string | null;
    isAbandoned: boolean;
  };
  conversationHistory: Message[];
}
```

#### Error Responses

**404 Not Found**
```json
{
  "error": "round_not_found",
  "message": "Round with ID 'xyz' not found",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**403 Forbidden - Not Owner**
```json
{
  "error": "forbidden",
  "message": "You don't have permission to access this round",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

---

### 4. Complete Round

**Endpoint:** `POST /api/game/complete-round`  
**Purpose:** Mark round as completed (win or loss)  
**Authentication:** Required (Bearer token)

#### Request

```typescript
interface CompleteRoundRequest {
  roundId: string;                   // UUID, required
  result: 'win' | 'lose';           // Required
  finalMeter: number;                // 0-100, required
  messageCount: number;              // Required
}
```

**Validation Rules:**
- `roundId`: Required, valid UUID
- `result`: Required, must be 'win' or 'lose'
- `finalMeter`: Required, 0-100 integer
- `messageCount`: Required, positive integer

#### Response (200 OK)

```typescript
interface CompleteRoundResponse {
  result: 'win' | 'lose';
  stats: {
    totalRounds: number;
    totalWins: number;
    totalLosses: number;
    winRate: number;        // 0-1 decimal
    currentStreak: number;  // Consecutive wins
    bestStreak: number;
  };
  roundSummary: {
    duration: number;       // Seconds
    messageCount: number;
    finalMeter: number;
  };
}
```

**Example Response:**
```json
{
  "result": "win",
  "stats": {
    "totalRounds": 15,
    "totalWins": 9,
    "totalLosses": 6,
    "winRate": 0.6,
    "currentStreak": 3,
    "bestStreak": 5
  },
  "roundSummary": {
    "duration": 420,
    "messageCount": 14,
    "finalMeter": 100
  }
}
```

#### Error Responses

**400 Bad Request - Invalid Result**
```json
{
  "error": "invalid_result",
  "message": "Result must be 'win' or 'lose'",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**404 Not Found**
```json
{
  "error": "round_not_found",
  "message": "Round not found or already completed",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

**409 Conflict - Already Completed**
```json
{
  "error": "round_already_completed",
  "message": "This round has already been completed",
  "completedAt": "2025-10-23T10:15:00Z",
  "result": "win",
  "timestamp": "2025-10-23T10:30:00Z"
}
```

---

### 5. Abandon Round

**Endpoint:** `POST /api/game/abandon-round`  
**Purpose:** Mark round as abandoned (user left without completing)  
**Authentication:** Required (Bearer token)

#### Request

```typescript
interface AbandonRoundRequest {
  roundId: string;  // UUID, required
}
```

#### Response (200 OK)

```typescript
interface AbandonRoundResponse {
  message: string;  // "Round marked as abandoned"
  roundId: string;
}
```

---

### 6. Get User Round History

**Endpoint:** `GET /api/game/rounds`  
**Purpose:** Get user's game history with pagination  
**Authentication:** Required (Bearer token)

#### Request

**Query Parameters:**
- `page` (number, default: 1): Page number (1-indexed)
- `size` (number, default: 10, max: 50): Items per page
- `status` (string, optional): Filter by status ('win', 'lose', 'abandoned', 'active')
- `sort` (string, default: 'startedAt,desc'): Sort field and direction

#### Response (200 OK)

```typescript
interface RoundHistoryResponse {
  rounds: RoundSummary[];
  pagination: {
    currentPage: number;
    totalPages: number;
    totalItems: number;
    itemsPerPage: number;
    hasNext: boolean;
    hasPrevious: boolean;
  };
}

interface RoundSummary {
  id: string;
  girlName: string;
  girlImageUrl: string;
  result: 'win' | 'lose' | 'abandoned' | null;
  finalMeter: number | null;
  messageCount: number;
  duration: number;        // Seconds
  startedAt: string;
  completedAt: string | null;
}
```

---

## Status Codes Summary

| Code | Meaning | Usage |
|------|---------|-------|
| 200 | OK | Successful girl generation, round retrieval, completion |
| 201 | Created | Successful round start |
| 400 | Bad Request | Invalid input, validation errors |
| 401 | Unauthorized | Missing or invalid auth token |
| 402 | Payment Required | Free tier limit reached |
| 403 | Forbidden | User doesn't own this round |
| 404 | Not Found | Round not found |
| 409 | Conflict | Round already completed |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Internal Server Error | Unexpected error |
| 503 | Service Unavailable | External service (image gen, vision AI) unavailable |

---

## Rate Limiting

| Endpoint | Limit | Window |
|----------|-------|--------|
| `POST /generate-girls` | 10 requests | 5 minutes per user |
| `POST /start-round` | 15 requests | 5 minutes per user |
| `POST /complete-round` | 30 requests | 5 minutes per user |

---

## Business Logic Notes

### Free Tier Limits

**Daily Round Limit: 5 rounds/day**
- Resets at midnight UTC
- Tracked by user_id and date
- Both won and lost rounds count toward limit
- Abandoned rounds also count

**Premium Tier: Unlimited rounds**

### Success Meter Rules

- Initial value: 20%
- Win threshold: ≥ 100%
- Loss threshold: ≤ 5%
- Range after each message: 0-100%
- Delta range: -8 to +8 per message

---

## Integration Notes

### Backend Implementation

```typescript
// src/app/api/game/generate-girls/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { generateGirlImage } from '@/lib/ai/imagen';
import { getRandomAttributes } from '@/lib/game/attributes';

export async function POST(request: Request) {
  // 1. Authenticate user
  // 2. Check free tier limit
  // 3. Generate 3 sets of random attributes
  // 4. Call image generation API (3 parallel requests)
  // 5. Upload images to Supabase Storage
  // 6. Return girl profiles
}
```

### Frontend Implementation

```typescript
// src/lib/api/game.ts
import { z } from 'zod';

export const startRoundSchema = z.object({
  girlId: z.string().uuid(),
  girlData: z.object({
    id: z.string().uuid(),
    name: z.string(),
    imageUrl: z.string().url(),
    attributes: z.object({
      ethnicity: z.string(),
      hairColor: z.string(),
      eyeColor: z.string(),
      bodyType: z.string(),
      hairstyle: z.string(),
      setting: z.string(),
    }),
  }),
});

export type StartRoundRequest = z.infer<typeof startRoundSchema>;

// React Query hook
export function useStartRound() {
  return useMutation({
    mutationFn: async (data: StartRoundRequest) => {
      const response = await fetch('/api/game/start-round', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message);
      }

      return response.json();
    },
  });
}
```

---

## Testing Checklist

- [ ] Generate girls successfully with valid auth
- [ ] Generate girls fails without auth (401)
- [ ] Generate girls respects free tier limit (402)
- [ ] Generate girls handles image generation failures gracefully
- [ ] Start round creates database entry
- [ ] Start round generates girl description via Vision AI
- [ ] Start round initializes success meter at 20%
- [ ] Get round details returns correct data
- [ ] Get round details fails for non-owner (403)
- [ ] Complete round updates user stats
- [ ] Complete round with 'win' increases win count
- [ ] Complete round with 'lose' increases loss count
- [ ] Complete round updates streak correctly
- [ ] Complete round fails if already completed (409)
- [ ] Abandon round marks as abandoned
- [ ] Round history pagination works correctly
- [ ] Round history filters by status
- [ ] Rate limiting triggers correctly

